import{j as i}from"./AboutSimple-Cf8x2fCZ.js";import{r as V}from"./index-BH53Isel.js";import"./EditorLayout-3dTmWtvf.js";import"./EditorMain-rmOX089k.js";import{M as ge}from"./PaymentModal-Bxx5p2o_.js";import{H as xe}from"./index.es-p8wkj5I3.js";import{G as ce}from"./Global-ErywZRdd.js";import{l as we,g as ve}from"./TextElement-t0TJofq8.js";import{X as ue}from"./x-DBMwyD6F.js";import{C as Ie}from"./chevron-left-B2s3ZsB7.js";import{C as Ne}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./index-BSWw-p5k.js";import"./createLucideIcon-Cy5Ya80P.js";import"./copy-6OEekgvq.js";import"./trash-2-DK1wnsDn.js";const pe={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},Pe=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;ge.setAppElement("#app");const Ve=({isOpen:j,onRequestClose:m,pages:w,pageThumbnails:E={},addAlbumToCart:Y,workspaceDimensions:k={width:800,height:600},layouts:K=[],presetData:ie=null})=>{const[J,re]=V.useState(0),[G,q]=V.useState(!1),[ae,X]=V.useState({}),[le,ee]=V.useState(!1),D=V.useRef();function h(t,o,a,e,r,n){const f=o.width,P=o.height,M=r/n,g=f/P;let s=0,l=0,p=f,c=P;M>g?(c=f/M,l=(P-c)/2):(p=P*M,s=(f-p)/2),t.drawImage(o,s,l,p,c,a,e,r,n)}function C(t){const o=t.match(/grid-cols-(\d+)/),a=t.match(/grid-rows-(\d+)/),e=t.match(/gap-(\d+)/);return{cols:o?parseInt(o[1],10):1,rows:a?parseInt(a[1],10):1,gap:e?parseInt(e[1],10)*4:0}}function I(t,o,a=1){const e=t&&t.match(new RegExp(`${o}-span-(\\d+)`));return e?parseInt(e[1],10):a}function W(t,o,a){const{cols:e,rows:r,gap:n}=C(t.template),f=t.style&&t.style.padding?parseInt(t.style.padding):0,P=o.width-2*f,M=o.height-2*f,g=(P-n*(e-1))/e,s=(M-n*(r-1))/r,l=Array.from({length:r},()=>Array(e).fill(!1)),p={};for(let c=0;c<t.cells;c++){const Q=t.cellStyles&&t.cellStyles[c]?t.cellStyles[c]:"",F=I(Q,"col",1),$=I(Q,"row",1);let _=!1;for(let v=0;v<=r-$&&!_;v++)for(let L=0;L<=e-F&&!_;L++){let H=!0;for(let T=v;T<v+$;T++){for(let x=L;x<L+F;x++)if(l[T][x]){H=!1;break}if(!H)break}if(H){for(let x=v;x<v+$;x++)for(let b=L;b<L+F;b++)l[x][b]=!0;const T=a&&a[c]?a[c].id:c;p[T]={x:f+L*(g+n),y:f+v*(s+n),width:g*F+n*(F-1),height:s*$+n*($-1)},console.log(`[GRID-PLACEMENT] cellId:${T} col-span:${F} row-span:${$} => x:${p[T].x} y:${p[T].y} w:${p[T].width} h:${p[T].height}`),_=!0}}if(!_){const v=a&&a[c]?a[c].id:c;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${v}`),p[v]={x:0,y:0,width:g,height:s}}}return p}const U=V.useCallback(async()=>{if(!w||w.length===0||!j)return;console.log("🚀 Iniciando generación de thumbnails para BookPreview..."),ee(!0),X({});const t={},o=4;for(let a=0;a<w.length;a++){const e=w[a],r=document.createElement("canvas"),n=r.getContext("2d");if(r.width=k.width*o,r.height=k.height*o,console.log(`🔧 [THUMBNAIL] Generando thumbnail para página ${a} (${e.type})`),e.backgroundImage)try{const g=new Image;g.crossOrigin="anonymous",await new Promise((s,l)=>{g.onload=()=>{h(n,g,0,0,r.width,r.height),s()},g.onerror=()=>{n.fillStyle=e.backgroundColor||"#ffffff",n.fillRect(0,0,r.width,r.height),s()},g.src=e.backgroundImage})}catch{n.fillStyle=e.backgroundColor||"#ffffff",n.fillRect(0,0,r.width,r.height)}else n.fillStyle=e.backgroundColor||"#ffffff",n.fillRect(0,0,r.width,r.height);const f=K.find(g=>g.id===e.layout);console.log(`🔧 [THUMBNAIL] Looking for layout: ${e.layout}, found:`,!!f);let P={};if(f)P=W(f,{width:k.width*o,height:k.height*o},e.cells);else{console.warn(`⚠️ [THUMBNAIL] Layout not found for page ${a}:`,e.layout);for(const g of e.cells)P[g.id]={x:0,y:0,width:k.width*o,height:k.height*o}}for(const g of e.cells){const s=P[g.id];if(!s){console.warn(`⚠️ [THUMBNAIL] Cell position not found for cell: ${g.id}`);continue}console.log(`🔧 [THUMBNAIL] Processing cell ${g.id} with ${g.elements.length} elements`);for(const l of g.elements){console.log(`🔧 [THUMBNAIL] Drawing element ${l.id} (${l.type}): "${l.content}"`);const p=l.position||{x:0,y:0},c=l.size||{},Q=(p.x||0)*(s.width/o),F=(p.y||0)*(s.height/o);let $,_;if(c.width&&c.height){const x=c.width>1?c.width/100:c.width,b=c.height>1?c.height/100:c.height;$=s.width/o*x,_=s.height/o*b}else l.type==="text"?($=s.width/o*.8,_=s.height/o*.3):($=s.width/o*.5,_=s.height/o*.5);const v=(s.x/o+Q)*o,L=(s.y/o+F)*o,H=$*o,T=_*o;if(console.log(`🔧 [THUMBNAIL] Element absolute: x=${v}, y=${L}, w=${H}, h=${T}`),l.type==="image"&&l.content)try{const x=new Image;x.crossOrigin="anonymous",await new Promise((b,te)=>{x.onload=()=>{h(n,x,v,L,H,T),console.log(`✅ [THUMBNAIL] Image element drawn: ${l.id}`),b()},x.onerror=()=>{console.error("❌ [THUMBNAIL] Failed to load image element:",l.content),b()},x.src=l.content})}catch(x){console.error("❌ [THUMBNAIL] Error loading image element:",x)}else if(l.type==="text"&&l.content){console.log(`🔧 [THUMBNAIL] Drawing text element: "${l.content}"`);const x=l.style||{};x.fontFamily&&await we(x.fontFamily);const b=ve(x,o);n.save(),n.strokeStyle="#ff0000",n.lineWidth=2,n.strokeRect(v,L,H,T),n.font=`${b.fontWeight} ${b.fontStyle} ${b.fontSize} ${b.fontFamily}`,n.fillStyle=b.color,n.textAlign="left",n.textBaseline="top",b.backgroundColor!=="transparent"&&(n.fillStyle=b.backgroundColor,n.fillRect(v,L,H,T),n.fillStyle=b.color);const te=b.padding;let oe=v+te;const he=L+te,be=H-te*2;b.textAlign==="center"?(oe=v+H/2,n.textAlign="center"):b.textAlign==="right"?(oe=v+H-te,n.textAlign="right"):n.textAlign="left";const ye=l.content.split(`
`),de=parseInt(b.fontSize)*parseFloat(b.lineHeight);let Z=he;console.log(`🔧 [THUMBNAIL] Text details: font=${n.font}, color=${n.fillStyle}, x=${oe}, y=${he}`),ye.forEach((me,je)=>{if(!me.trim()){Z+=de;return}let se=me.split(" "),O="";for(let ne=0;ne<se.length;ne++){let fe=O?O+" "+se[ne]:se[ne];n.measureText(fe).width>be&&O?(n.fillText(O,oe,Z),console.log(`🔧 [THUMBNAIL] Drew line: "${O}" at y=${Z}`),O=se[ne],Z+=de):O=fe}O&&(n.fillText(O,oe,Z),console.log(`🔧 [THUMBNAIL] Drew final line: "${O}" at y=${Z}`),Z+=de)}),n.restore(),console.log(`✅ [THUMBNAIL] Text element drawn: ${l.id}`)}}}const M=r.toDataURL("image/jpeg",.9);console.log(`🎯 [THUMBNAIL] Generated thumbnail for page ${a}`),t[a]=M}X(t),ee(!1)},[w,j,k,K,ie]);V.useEffect(()=>{j&&(Object.keys(E).length===0?U():X(E))},[j,E]),V.useEffect(()=>{j||X({})},[j]);const R=Object.keys(E).length>0?E:ae;if(!w||!Array.isArray(w)||w.length===0)return i.jsx(ge,{isOpen:j,onRequestClose:m,style:pe,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:i.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[i.jsxs("div",{className:"flex justify-between items-center mb-4",children:[i.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del álbum"}),i.jsx("button",{onClick:m,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:i.jsx(ue,{size:24})})]}),i.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay páginas disponibles para mostrar."})]})});const A=()=>{D.current&&D.current.pageFlip().flipPrev()},B=()=>{D.current&&D.current.pageFlip().flipNext()},S=k.width/k.height,u=600,d=Math.round(u*S),y=(()=>{const t=[],o=[...w.filter(e=>e.type==="cover"),...w.filter(e=>e.type==="content"),...w.filter(e=>e.type==="final")];o.length>0&&(t.push(o[0]),t.push({...o[0],isBack:!0}));for(let e=1;e<o.length-1;e++)t.push(o[e]),e+1<o.length-1?(t.push(o[e+1]),e++):t.push({...o[e],isBack:!0,isEmpty:!0});const a=o.find(e=>e.type==="final");return a&&(t.push({...a,isBack:!0,isEmpty:!0}),t.push(a)),t})();return i.jsxs(ge,{isOpen:j,onRequestClose:m,style:pe,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[i.jsx("style",{dangerouslySetInnerHTML:{__html:Pe}}),le&&i.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:i.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[i.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),i.jsx("p",{className:"text-gray-700",children:"Generando vistas previas de alta calidad..."}),i.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),i.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[i.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del álbum"}),i.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las páginas de su álbum usando los controles de navegación o teclado. Puede cerrar esta ventana presionando Escape o el botón de cerrar."}),i.jsx("button",{onClick:m,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del álbum",children:i.jsx(ue,{className:"h-6 w-6"})}),i.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[i.jsx("button",{onClick:A,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página anterior",children:i.jsx(Ie,{className:"h-6 w-6"})}),i.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const t=y[J];return t?t.isBack&&t.isEmpty?"Reverso":t.isBack?"Reverso de la página":t.type==="cover"?"Portada":t.type==="final"?"Contraportada":`Página ${t.pageNumber||Math.ceil((J+1)/2)}`:"Cargando..."})(),i.jsx("span",{className:"mx-2 text-gray-400",children:"•"}),Math.ceil((J+1)/2)," / ",Math.ceil(y.length/2)," hojas"]}),i.jsx("button",{onClick:B,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página siguiente",children:i.jsx(Ne,{className:"h-6 w-6"})})]}),i.jsx("div",{className:"flex items-center justify-center",children:i.jsx(xe,{ref:D,width:d,height:u,size:"stretch",minWidth:d*.7,maxWidth:d*1.3,minHeight:u*.7,maxHeight:u*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:t=>re(t.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:y.map((t,o)=>i.jsx("div",{id:`page-${t.id}`,className:"page-container",style:{width:d,height:u,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:i.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:t.isEmpty||t.isBack?i.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:t.isBack?"Reverso":""}):R[t.id]?i.jsx("img",{src:R[t.id],alt:`${t.type==="cover"?"Portada":t.type==="final"?"Contraportada":`Página ${t.pageNumber||o+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):i.jsx(Ae,{page:t,pageIdx:o})})},`page-${o}`))})})]}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-md mx-auto",children:[i.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${G?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var t,o,a;if(!G){q(!0);try{if(console.log("🚀 Iniciando proceso de compra con generación de PDF..."),typeof Y!="function"){console.error("❌ addAlbumToCart no es una función"),console.log("addAlbumToCart type:",typeof Y),console.log("addAlbumToCart value:",Y),alert("Error: Función de carrito no disponible. Inténtelo nuevamente.");return}if(typeof window.finalizeAlbumDesign=="function"){console.log("📄 Finalizando diseño del álbum...");const e=await window.finalizeAlbumDesign();if(console.log("📄 Resultado de finalizeAlbumDesign:",e),e){if(console.log("📄 Generando PDF del álbum..."),typeof window.generateAlbumPDF=="function")try{const n=await window.generateAlbumPDF();console.log("📄 PDF generado exitosamente:",n),console.log("💾 Guardando PDF en el servidor...");const f=window.currentAlbumUuid||window.albumUuid;if(!f)throw new Error("No se encontró el UUID del álbum");const P=await new Promise((s,l)=>{const p=new FileReader;p.onload=()=>{const c=p.result.split(",")[1];s(c)},p.onerror=l,p.readAsDataURL(n)}),M=await fetch(`/api/albums/${f}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content"))||""},body:JSON.stringify({pdf_blob:P})});if(!M.ok){const s=await M.json();throw new Error(s.message||"Error al guardar el PDF en el servidor")}const g=await M.json();console.log("💾 PDF guardado en servidor:",g)}catch(n){console.error("❌ Error generando/guardando PDF:",n),console.log("⚠️ Continuando sin PDF...")}else console.warn("⚠️ window.generateAlbumPDF no está disponible, continuando sin PDF...");console.log("📦 Agregando álbum al carrito...");const r=Y();if(console.log("📦 Resultado de addAlbumToCart:",r),r){console.log("✅ Álbum agregado al carrito exitosamente");try{await new Promise(P=>setTimeout(P,200));const n=JSON.parse(localStorage.getItem(`${((o=window.Global)==null?void 0:o.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");console.log("🔍 Verificación final del carrito:",n),console.log("🔍 Longitud del carrito:",n.length),n.length===0&&console.error("❌ ADVERTENCIA: El carrito parece vacío después de agregar");const f=`${ce.APP_URL}/cart`;console.log("🔄 Redirigiendo al carrito..."),console.log("🔄 URL del carrito:",f),window.location.href=f}catch(n){console.error("⚠️ Error durante verificación o redirección:",n),console.log("🔄 Intentando redirección directa...");const f=`${ce.APP_URL}/cart`;console.log("🔄 Redirigiendo al carrito..."),console.log("🔄 URL del carrito:",f),window.location.href=f}}else console.error("❌ No se pudo agregar al carrito"),alert("Error al agregar el álbum al carrito. Revise la consola para más detalles.")}else console.error("❌ No se pudo finalizar el diseño del álbum"),alert("Error al finalizar el diseño del álbum. Inténtelo nuevamente.")}else console.error("❌ window.finalizeAlbumDesign no está disponible"),alert("Funcionalidad de finalización de diseño pendiente de implementar.")}catch(e){console.error("❌ === ERROR DURANTE PROCESO DE COMPRA ==="),console.error("Tipo de error:",e.name),console.error("Mensaje:",e.message),console.error("Stack trace:",e.stack),console.error("Error completo:",e);try{const r=JSON.parse(localStorage.getItem(`${((a=ce)==null?void 0:a.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");if(console.log("🔍 Verificando carrito después del error:",r.length>0?"HAY ITEMS":"VACÍO"),r.length>0){console.log("✅ El carrito tiene items, redirigiendo de todas formas...");const n=`${ce.APP_URL}/cart`;console.log("🔄 Redirigiendo al carrito..."),console.log("🔄 URL del carrito:",n),window.location.href=n;return}}catch(r){console.error("❌ Error durante intento de recuperación:",r)}alert(`Error durante el proceso: ${e.message}. Si el álbum se agregó al carrito, puede ir manualmente a la página del carrito.`)}finally{q(!1)}}},disabled:G,children:G?i.jsxs(i.Fragment,{children:[i.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[i.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),i.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),i.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:m,disabled:G,children:"Continuar editando"})]}),"        "]})},Ae=({page:j,pageIdx:m})=>{let w="",E="";switch(j.type){case"cover":w="Portada",E="📚";break;case"final":w="Contraportada",E="📖";break;case"content":w=`Página ${j.pageNumber||m+1}`,E="📄";break;default:w=`Página ${m+1}`,E="📄"}return i.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[i.jsx("div",{className:"text-6xl mb-4",children:E}),i.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:w}),i.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),j.layout&&i.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",j.layout.name||"Personalizado"]})]})};async function Ye({pages:j,workspaceDimensions:m,presetData:w}){var k,K,ie,J,re,G,q,ae,X,le,ee,D;const E={};function Y(h,C,I,W,U,R){if(!C||!h){console.warn("⚠️ No se puede dibujar: contexto o imagen no válidos");return}const A=C.width,B=C.height;if(A===0||B===0){console.warn("⚠️ Imagen con dimensiones cero:",{sWidth:A,sHeight:B});return}if(U<=0||R<=0){console.warn("⚠️ Dimensiones de destino inválidas:",{dWidth:U,dHeight:R});return}const S=U/R,z=A/B;let u,d,N,y;S>z?(N=A,y=N/S,u=0,d=(B-y)/2):(y=B,N=y*S,u=(A-N)/2,d=0);try{h.save(),h.imageSmoothingQuality="high",h.drawImage(C,Math.max(0,u),Math.max(0,d),Math.min(N,A-u),Math.min(y,B-d),I,W,U,R),h.restore()}catch(t){console.error("❌ Error al dibujar imagen:",t),console.error("Detalles:",{source:{x:u,y:d,width:N,height:y},dest:{x:I,y:W,width:U,height:R},imgSize:{width:A,height:B}})}}for(const h of j)try{const C=document.createElement("canvas"),I=C.getContext("2d",{willReadFrequently:!0});C.width=m.width,C.height=m.height,I.scale(1,1),I.imageSmoothingEnabled=!0,I.imageSmoothingQuality="high",I.textRendering="geometricPrecision",I.webkitImageSmoothingEnabled=!0,I.mozImageSmoothingEnabled=!0,I.msImageSmoothingEnabled=!0,console.log("🖼️ [THUMBNAIL] Generando miniatura para página:",h==null?void 0:h.type),console.log("🖼️ [THUMBNAIL] backgroundImage:",h==null?void 0:h.backgroundImage),console.log("🖼️ [THUMBNAIL] backgroundColor:",h==null?void 0:h.backgroundColor);let W=h.backgroundImage,U=h.backgroundColor||"#ffffff";if(console.log("🖼️ [THUMBNAIL] URL final:",W),console.log("🎨 [THUMBNAIL] Color final:",U),I.fillStyle=U,I.fillRect(0,0,m.width,m.height),W){console.log("🖼️ [THUMBNAIL] Cargando imagen de fondo:",W);try{const u=new window.Image;u.crossOrigin="anonymous",u.src=W,await new Promise((d,N)=>{if(u.complete)return console.log("✅ [THUMBNAIL] Imagen ya cargada"),d();u.onload=()=>{console.log("✅ [THUMBNAIL] Imagen cargada exitosamente"),d()},u.onerror=y=>{console.error("❌ [THUMBNAIL] Error cargando imagen:",y),N(y)}}),Y(I,u,0,0,m.width,m.height),console.log("✅ [THUMBNAIL] Imagen de fondo dibujada")}catch(u){console.error("❌ [THUMBNAIL] Error procesando imagen de fondo:",u)}}else console.log("ℹ️ [THUMBNAIL] Sin imagen de fondo, usando solo color");if(h.cells&&Array.isArray(h.cells)){const u=[...h.cells].sort((d,N)=>{var o,a,e,r;const y=((o=d.position)==null?void 0:o.y)||0,t=((a=N.position)==null?void 0:a.y)||0;return y!==t?y-t:(((e=d.position)==null?void 0:e.x)||0)-(((r=N.position)==null?void 0:r.x)||0)});for(const d of u){if(!d||!d.elements)continue;const N=((k=d.size)==null?void 0:k.width)||m.width,y=((K=d.size)==null?void 0:K.height)||m.height,t=((ie=d.position)==null?void 0:ie.x)||0,o=((J=d.position)==null?void 0:J.y)||0;d.size||console.warn("⚠️ cell.size no definido, usando tamaño workspace",d);const a=[...d.elements||[]].sort((e,r)=>(e.zIndex||0)-(r.zIndex||0));for(const e of a)if(!(e.type==="image"&&(e.id==="cover-base"||e.id==="final-base"||typeof e.id=="string"&&e.id.startsWith("content-base-")))&&!(!e||e.type!=="image"&&e.type!=="text"||!e.content)&&e.type==="image")try{const r=new Image;r.crossOrigin="anonymous",await new Promise((F,$)=>{r.onload=F,r.onerror=$,r.src=e.content});const n=((re=e.position)==null?void 0:re.x)!==void 0&&Math.abs(e.position.x)<=1,f=((G=e.position)==null?void 0:G.y)!==void 0&&Math.abs(e.position.y)<=1,P=((q=e.size)==null?void 0:q.width)!==void 0&&e.size.width<=1,M=((ae=e.size)==null?void 0:ae.height)!==void 0&&e.size.height<=1,g=n?e.position.x*N:((X=e.position)==null?void 0:X.x)||0,s=f?e.position.y*y:((le=e.position)==null?void 0:le.y)||0,l=P?e.size.width*N:((ee=e.size)==null?void 0:ee.width)||N,p=M?e.size.height*y:((D=e.size)==null?void 0:D.height)||y,c=t+g,Q=o+s;console.log("📐 Renderizando elemento:",{elementId:e.id,cellId:d.id,cellPosition:{x:t,y:o,width:N,height:y},elementPosition:{x:g,y:s,width:l,height:p},finalPosition:{dx:c,dy:Q},isRelative:{x:n,y:f,w:P,h:M},elementData:e}),Y(I,r,c,Q,l,p)}catch(r){console.error("Error al cargar imagen:",r,e)}}}const R=document.createElement("canvas"),A=R.getContext("2d"),B=900;let S,z;m.width>m.height?(S=Math.min(B,m.width),z=S/m.width*m.height):(z=Math.min(B,m.height),S=z/m.height*m.width),S=Math.round(S),z=Math.round(z),R.width=S,R.height=z,A.imageSmoothingEnabled=!0,A.imageSmoothingQuality="high",A.webkitImageSmoothingEnabled=!0,A.mozImageSmoothingEnabled=!0,A.msImageSmoothingEnabled=!0,A.drawImage(C,0,0,C.width,C.height,0,0,S,z),E[h.id]=R.toDataURL("image/png",.92)}catch(C){console.error(`❌ Error generando thumbnail para página ${h.id}:`,C),E[h.id]=null}return E}export{Ve as B,Ye as g};
