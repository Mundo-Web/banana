import{j as r}from"./AboutSimple-Cf8x2fCZ.js";import{r as Y}from"./index-BH53Isel.js";import"./EditorLayout-3dTmWtvf.js";import"./EditorMain-rmOX089k.js";import{M as fe}from"./PaymentModal-Bxx5p2o_.js";import{H as we}from"./index.es-p8wkj5I3.js";import{G as me}from"./Global-ErywZRdd.js";import{l as ve,g as Ie}from"./TextElement-t0TJofq8.js";import{X as ye}from"./x-DBMwyD6F.js";import{C as Ne}from"./chevron-left-B2s3ZsB7.js";import{C as Ae}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./index-BSWw-p5k.js";import"./createLucideIcon-Cy5Ya80P.js";import"./copy-6OEekgvq.js";import"./trash-2-DK1wnsDn.js";const be={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},Pe=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;fe.setAppElement("#app");const Ye=({isOpen:T,onRequestClose:m,pages:I,pageThumbnails:M={},addAlbumToCart:V,workspaceDimensions:L={width:800,height:600},layouts:K=[],presetData:ne=null})=>{const[Q,ae]=Y.useState(0),[_,q]=Y.useState(!1),[re,X]=Y.useState({}),[le,ee]=Y.useState(!1),G=Y.useRef();function te(o,i,c,n,l,t){const s=i.width,g=i.height,w=l/t,f=s/g;let y=0,e=0,a=s,h=g;w>f?(h=s/w,e=(g-h)/2):(a=g*w,y=(s-a)/2),o.drawImage(i,y,e,a,h,c,n,l,t)}function se(o){const i=o.match(/grid-cols-(\d+)/),c=o.match(/grid-rows-(\d+)/),n=o.match(/gap-(\d+)/);return{cols:i?parseInt(i[1],10):1,rows:c?parseInt(c[1],10):1,gap:n?parseInt(n[1],10)*4:0}}function oe(o,i,c=1){const n=o&&o.match(new RegExp(`${i}-span-(\\d+)`));return n?parseInt(n[1],10):c}function ce(o,i,c){const{cols:n,rows:l,gap:t}=se(o.template),s=o.style&&o.style.padding?parseInt(o.style.padding):0,g=i.width-2*s,w=i.height-2*s,f=(g-t*(n-1))/n,y=(w-t*(l-1))/l,e=Array.from({length:l},()=>Array(n).fill(!1)),a={};for(let h=0;h<o.cells;h++){const k=o.cellStyles&&o.cellStyles[h]?o.cellStyles[h]:"",S=oe(k,"col",1),N=oe(k,"row",1);let j=!1;for(let x=0;x<=l-N&&!j;x++)for(let v=0;v<=n-S&&!j;v++){let P=!0;for(let b=x;b<x+N;b++){for(let u=v;u<v+S;u++)if(e[b][u]){P=!1;break}if(!P)break}if(P){for(let u=x;u<x+N;u++)for(let C=v;C<v+S;C++)e[u][C]=!0;const b=c&&c[h]?c[h].id:h;a[b]={x:s+v*(f+t),y:s+x*(y+t),width:f*S+t*(S-1),height:y*N+t*(N-1)},console.log(`[GRID-PLACEMENT] cellId:${b} col-span:${S} row-span:${N} => x:${a[b].x} y:${a[b].y} w:${a[b].width} h:${a[b].height}`),j=!0}}if(!j){const x=c&&c[h]?c[h].id:h;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${x}`),a[x]={x:0,y:0,width:f,height:y}}}return a}const de=Y.useCallback(async()=>{if(!I||I.length===0||!T)return;console.log("üöÄ Iniciando generaci√≥n de thumbnails para BookPreview..."),ee(!0),X({});const o={},i=4;for(let c=0;c<I.length;c++){const n=I[c],l=document.createElement("canvas"),t=l.getContext("2d");if(l.width=L.width*i,l.height=L.height*i,console.log(`üîß [THUMBNAIL] Generando thumbnail para p√°gina ${c} (${n.type})`),n.backgroundImage)try{const f=new Image;f.crossOrigin="anonymous",await new Promise((y,e)=>{f.onload=()=>{te(t,f,0,0,l.width,l.height),y()},f.onerror=()=>{t.fillStyle=n.backgroundColor||"#ffffff",t.fillRect(0,0,l.width,l.height),y()},f.src=n.backgroundImage})}catch{t.fillStyle=n.backgroundColor||"#ffffff",t.fillRect(0,0,l.width,l.height)}else t.fillStyle=n.backgroundColor||"#ffffff",t.fillRect(0,0,l.width,l.height);const s=K.find(f=>f.id===n.layout);console.log(`üîß [THUMBNAIL] Looking for layout: ${n.layout}, found:`,!!s);let g={};if(s)g=ce(s,{width:L.width*i,height:L.height*i},n.cells);else{console.warn(`‚ö†Ô∏è [THUMBNAIL] Layout not found for page ${c}:`,n.layout);for(const f of n.cells)g[f.id]={x:0,y:0,width:L.width*i,height:L.height*i}}for(const f of n.cells){const y=g[f.id];if(!y){console.warn(`‚ö†Ô∏è [THUMBNAIL] Cell position not found for cell: ${f.id}`);continue}console.log(`üîß [THUMBNAIL] Processing cell ${f.id} with ${f.elements.length} elements`);const e=f.elements.sort((a,h)=>(a.zIndex||0)-(h.zIndex||0));for(const a of e){console.log(`üîß [THUMBNAIL] Drawing element ${a.id} (${a.type}): "${a.content}"`);const h=a.position||{x:0,y:0},k=y.x/i,S=y.y/i,N=y.width/i,j=y.height/i,x=h.x!==void 0&&Math.abs(h.x)<=1,v=h.y!==void 0&&Math.abs(h.y)<=1,P=x?h.x*N:h.x||0,b=v?h.y*j:h.y||0,u=k+P,C=S+b;if(a.type==="image"&&a.content)try{const R=new Image;R.crossOrigin="anonymous",await new Promise((A,U)=>{R.onload=()=>{const H=a.size||{},J=H.width!==void 0&&H.width<=1,W=H.height!==void 0&&H.height<=1,B=J?H.width*N:H.width||N*.8,Z=W?H.height*j:H.height||j*.8;te(t,R,u*i,C*i,B*i,Z*i),console.log(`‚úÖ [THUMBNAIL] Image element drawn: ${a.id} at (${u}, ${C}) size (${B}, ${Z})`),A()},R.onerror=()=>{console.error("‚ùå [THUMBNAIL] Failed to load image element:",a.content),A()},R.src=a.content})}catch(R){console.error("‚ùå [THUMBNAIL] Error loading image element:",R)}else if(a.type==="text"&&a.content){console.log(`üîß [THUMBNAIL] Drawing text element: "${a.content}" at relative pos (${h.x}, ${h.y})`);const R=a.style||{};R.fontFamily&&await ve(R.fontFamily);const A=Ie(R,i);t.save(),t.font=`${A.fontWeight} ${A.fontStyle} ${A.fontSize} ${A.fontFamily}`,t.fillStyle=A.color,t.textAlign=A.textAlign,t.textBaseline="top";const U=a.size||{},H=U.width!==void 0&&U.width<=1,J=U.height!==void 0&&U.height<=1,W=H?U.width*N:U.width||N*.8,B=J?U.height*j:U.height||j*.3;t.strokeStyle="#ff0000",t.lineWidth=2,t.strokeRect(u*i,C*i,W*i,B*i),A.backgroundColor!=="transparent"&&(t.fillStyle=A.backgroundColor,t.fillRect(u*i,C*i,W*i,B*i),t.fillStyle=A.color);const Z=a.content.split(`
`),D=parseInt(A.fontSize)*parseFloat(A.lineHeight);Z.forEach((O,xe)=>{if(O.trim()){const ue=u*i+(A.padding||0),pe=C*i+xe*D+(A.padding||0);console.log(`üîß [THUMBNAIL] Drawing line "${O}" at x=${ue}, y=${pe}, posX=${u}, posY=${C}`),t.fillText(O,ue,pe)}}),t.restore(),console.log(`‚úÖ [THUMBNAIL] Text element drawn: ${a.id} at (${u}, ${C}) size (${W}, ${B})`)}}}const w=l.toDataURL("image/jpeg",.9);console.log(`üéØ [THUMBNAIL] Generated thumbnail for page ${c}`),o[c]=w}X(o),ee(!1)},[I,T,L,K,ne]);Y.useEffect(()=>{T&&(Object.keys(M).length===0?de():X(M))},[T,M]),Y.useEffect(()=>{T||X({})},[T]);const ie=Object.keys(M).length>0?M:re;if(!I||!Array.isArray(I)||I.length===0)return r.jsx(fe,{isOpen:T,onRequestClose:m,style:be,contentLabel:"Vista previa del √°lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:r.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del √°lbum"}),r.jsx("button",{onClick:m,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:r.jsx(ye,{size:24})})]}),r.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay p√°ginas disponibles para mostrar."})]})});const ge=()=>{G.current&&G.current.pageFlip().flipPrev()},he=()=>{G.current&&G.current.pageFlip().flipNext()},p=L.width/L.height,d=600,z=Math.round(d*p),$=(()=>{const o=[],i=[...I.filter(n=>n.type==="cover"),...I.filter(n=>n.type==="content"),...I.filter(n=>n.type==="final")];i.length>0&&(o.push(i[0]),o.push({...i[0],isBack:!0}));for(let n=1;n<i.length-1;n++)o.push(i[n]),n+1<i.length-1?(o.push(i[n+1]),n++):o.push({...i[n],isBack:!0,isEmpty:!0});const c=i.find(n=>n.type==="final");return c&&(o.push({...c,isBack:!0,isEmpty:!0}),o.push(c)),o})();return r.jsxs(fe,{isOpen:T,onRequestClose:m,style:be,contentLabel:"Vista previa del √°lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[r.jsx("style",{dangerouslySetInnerHTML:{__html:Pe}}),le&&r.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),r.jsx("p",{className:"text-gray-700",children:"Generando vistas previas de alta calidad..."}),r.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),r.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[r.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del √°lbum"}),r.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las p√°ginas de su √°lbum usando los controles de navegaci√≥n o teclado. Puede cerrar esta ventana presionando Escape o el bot√≥n de cerrar."}),r.jsx("button",{onClick:m,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del √°lbum",children:r.jsx(ye,{className:"h-6 w-6"})}),r.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[r.jsx("button",{onClick:ge,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"P√°gina anterior",children:r.jsx(Ne,{className:"h-6 w-6"})}),r.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const o=$[Q];return o?o.isBack&&o.isEmpty?"Reverso":o.isBack?"Reverso de la p√°gina":o.type==="cover"?"Portada":o.type==="final"?"Contraportada":`P√°gina ${o.pageNumber||Math.ceil((Q+1)/2)}`:"Cargando..."})(),r.jsx("span",{className:"mx-2 text-gray-400",children:"‚Ä¢"}),Math.ceil((Q+1)/2)," / ",Math.ceil($.length/2)," hojas"]}),r.jsx("button",{onClick:he,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"P√°gina siguiente",children:r.jsx(Ae,{className:"h-6 w-6"})})]}),r.jsx("div",{className:"flex items-center justify-center",children:r.jsx(we,{ref:G,width:z,height:d,size:"stretch",minWidth:z*.7,maxWidth:z*1.3,minHeight:d*.7,maxHeight:d*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:o=>ae(o.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:$.map((o,i)=>r.jsx("div",{id:`page-${o.id}`,className:"page-container",style:{width:z,height:d,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:r.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:o.isEmpty||o.isBack?r.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:o.isBack?"Reverso":""}):ie[o.id]?r.jsx("img",{src:ie[o.id],alt:`${o.type==="cover"?"Portada":o.type==="final"?"Contraportada":`P√°gina ${o.pageNumber||i+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):r.jsx(je,{page:o,pageIdx:i})})},`page-${i}`))})})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-md mx-auto",children:[r.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${_?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var o,i,c;if(!_){q(!0);try{if(console.log("üöÄ Iniciando proceso de compra con generaci√≥n de PDF..."),typeof V!="function"){console.error("‚ùå addAlbumToCart no es una funci√≥n"),console.log("addAlbumToCart type:",typeof V),console.log("addAlbumToCart value:",V),alert("Error: Funci√≥n de carrito no disponible. Int√©ntelo nuevamente.");return}if(typeof window.finalizeAlbumDesign=="function"){console.log("üìÑ Finalizando dise√±o del √°lbum...");const n=await window.finalizeAlbumDesign();if(console.log("üìÑ Resultado de finalizeAlbumDesign:",n),n){if(console.log("üìÑ Generando PDF del √°lbum..."),typeof window.generateAlbumPDF=="function")try{const t=await window.generateAlbumPDF();console.log("üìÑ PDF generado exitosamente:",t),console.log("üíæ Guardando PDF en el servidor...");const s=window.currentAlbumUuid||window.albumUuid;if(!s)throw new Error("No se encontr√≥ el UUID del √°lbum");const g=await new Promise((y,e)=>{const a=new FileReader;a.onload=()=>{const h=a.result.split(",")[1];y(h)},a.onerror=e,a.readAsDataURL(t)}),w=await fetch(`/api/albums/${s}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},body:JSON.stringify({pdf_blob:g})});if(!w.ok){const y=await w.json();throw new Error(y.message||"Error al guardar el PDF en el servidor")}const f=await w.json();console.log("üíæ PDF guardado en servidor:",f)}catch(t){console.error("‚ùå Error generando/guardando PDF:",t),console.log("‚ö†Ô∏è Continuando sin PDF...")}else console.warn("‚ö†Ô∏è window.generateAlbumPDF no est√° disponible, continuando sin PDF...");console.log("üì¶ Agregando √°lbum al carrito...");const l=V();if(console.log("üì¶ Resultado de addAlbumToCart:",l),l){console.log("‚úÖ √Ålbum agregado al carrito exitosamente");try{await new Promise(g=>setTimeout(g,200));const t=JSON.parse(localStorage.getItem(`${((i=window.Global)==null?void 0:i.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");console.log("üîç Verificaci√≥n final del carrito:",t),console.log("üîç Longitud del carrito:",t.length),t.length===0&&console.error("‚ùå ADVERTENCIA: El carrito parece vac√≠o despu√©s de agregar");const s=`${me.APP_URL}/cart`;console.log("üîÑ Redirigiendo al carrito..."),console.log("üîÑ URL del carrito:",s),window.location.href=s}catch(t){console.error("‚ö†Ô∏è Error durante verificaci√≥n o redirecci√≥n:",t),console.log("üîÑ Intentando redirecci√≥n directa...");const s=`${me.APP_URL}/cart`;console.log("üîÑ Redirigiendo al carrito..."),console.log("üîÑ URL del carrito:",s),window.location.href=s}}else console.error("‚ùå No se pudo agregar al carrito"),alert("Error al agregar el √°lbum al carrito. Revise la consola para m√°s detalles.")}else console.error("‚ùå No se pudo finalizar el dise√±o del √°lbum"),alert("Error al finalizar el dise√±o del √°lbum. Int√©ntelo nuevamente.")}else console.error("‚ùå window.finalizeAlbumDesign no est√° disponible"),alert("Funcionalidad de finalizaci√≥n de dise√±o pendiente de implementar.")}catch(n){console.error("‚ùå === ERROR DURANTE PROCESO DE COMPRA ==="),console.error("Tipo de error:",n.name),console.error("Mensaje:",n.message),console.error("Stack trace:",n.stack),console.error("Error completo:",n);try{const l=JSON.parse(localStorage.getItem(`${((c=me)==null?void 0:c.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");if(console.log("üîç Verificando carrito despu√©s del error:",l.length>0?"HAY ITEMS":"VAC√çO"),l.length>0){console.log("‚úÖ El carrito tiene items, redirigiendo de todas formas...");const t=`${me.APP_URL}/cart`;console.log("üîÑ Redirigiendo al carrito..."),console.log("üîÑ URL del carrito:",t),window.location.href=t;return}}catch(l){console.error("‚ùå Error durante intento de recuperaci√≥n:",l)}alert(`Error durante el proceso: ${n.message}. Si el √°lbum se agreg√≥ al carrito, puede ir manualmente a la p√°gina del carrito.`)}finally{q(!1)}}},disabled:_,children:_?r.jsxs(r.Fragment,{children:[r.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),r.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:m,disabled:_,children:"Continuar editando"})]}),"        "]})},je=({page:T,pageIdx:m})=>{let I="",M="";switch(T.type){case"cover":I="Portada",M="üìö";break;case"final":I="Contraportada",M="üìñ";break;case"content":I=`P√°gina ${T.pageNumber||m+1}`,M="üìÑ";break;default:I=`P√°gina ${m+1}`,M="üìÑ"}return r.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[r.jsx("div",{className:"text-6xl mb-4",children:M}),r.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:I}),r.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),T.layout&&r.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",T.layout.name||"Personalizado"]})]})};async function Ve({pages:T,workspaceDimensions:m,presetData:I}){var L,K,ne,Q,ae,_,q,re,X,le,ee,G,te,se,oe,ce,de,ie,ge,he;const M={};function V(p,E,d,z,F,$){if(!E||!p){console.warn("‚ö†Ô∏è No se puede dibujar: contexto o imagen no v√°lidos");return}const o=E.width,i=E.height;if(o===0||i===0){console.warn("‚ö†Ô∏è Imagen con dimensiones cero:",{sWidth:o,sHeight:i});return}if(F<=0||$<=0){console.warn("‚ö†Ô∏è Dimensiones de destino inv√°lidas:",{dWidth:F,dHeight:$});return}const c=F/$,n=o/i;let l,t,s,g;c>n?(s=o,g=s/c,l=0,t=(i-g)/2):(g=i,s=g*c,l=(o-s)/2,t=0);try{p.save(),p.imageSmoothingQuality="high",p.drawImage(E,Math.max(0,l),Math.max(0,t),Math.min(s,o-l),Math.min(g,i-t),d,z,F,$),p.restore()}catch(w){console.error("‚ùå Error al dibujar imagen:",w),console.error("Detalles:",{source:{x:l,y:t,width:s,height:g},dest:{x:d,y:z,width:F,height:$},imgSize:{width:o,height:i}})}}for(const p of T)try{const E=document.createElement("canvas"),d=E.getContext("2d",{willReadFrequently:!0});E.width=m.width,E.height=m.height,d.scale(1,1),d.imageSmoothingEnabled=!0,d.imageSmoothingQuality="high",d.textRendering="geometricPrecision",d.webkitImageSmoothingEnabled=!0,d.mozImageSmoothingEnabled=!0,d.msImageSmoothingEnabled=!0,console.log("üñºÔ∏è [THUMBNAIL] Generando miniatura para p√°gina:",p==null?void 0:p.type),console.log("üñºÔ∏è [THUMBNAIL] backgroundImage:",p==null?void 0:p.backgroundImage),console.log("üñºÔ∏è [THUMBNAIL] backgroundColor:",p==null?void 0:p.backgroundColor);let z=p.backgroundImage,F=p.backgroundColor||"#ffffff";if(console.log("üñºÔ∏è [THUMBNAIL] URL final:",z),console.log("üé® [THUMBNAIL] Color final:",F),d.fillStyle=F,d.fillRect(0,0,m.width,m.height),z){console.log("üñºÔ∏è [THUMBNAIL] Cargando imagen de fondo:",z);try{const l=new window.Image;l.crossOrigin="anonymous",l.src=z,await new Promise((t,s)=>{if(l.complete)return console.log("‚úÖ [THUMBNAIL] Imagen ya cargada"),t();l.onload=()=>{console.log("‚úÖ [THUMBNAIL] Imagen cargada exitosamente"),t()},l.onerror=g=>{console.error("‚ùå [THUMBNAIL] Error cargando imagen:",g),s(g)}}),V(d,l,0,0,m.width,m.height),console.log("‚úÖ [THUMBNAIL] Imagen de fondo dibujada")}catch(l){console.error("‚ùå [THUMBNAIL] Error procesando imagen de fondo:",l)}}else console.log("‚ÑπÔ∏è [THUMBNAIL] Sin imagen de fondo, usando solo color");if(p.cells&&Array.isArray(p.cells)){const l=[...p.cells].sort((t,s)=>{var f,y,e,a;const g=((f=t.position)==null?void 0:f.y)||0,w=((y=s.position)==null?void 0:y.y)||0;return g!==w?g-w:(((e=t.position)==null?void 0:e.x)||0)-(((a=s.position)==null?void 0:a.x)||0)});for(const t of l){if(!t||!t.elements)continue;const s=((L=t.size)==null?void 0:L.width)||m.width,g=((K=t.size)==null?void 0:K.height)||m.height,w=((ne=t.position)==null?void 0:ne.x)||0,f=((Q=t.position)==null?void 0:Q.y)||0;t.size||console.warn("‚ö†Ô∏è cell.size no definido, usando tama√±o workspace",t);const y=[...t.elements||[]].sort((e,a)=>(e.zIndex||0)-(a.zIndex||0));for(const e of y)if(!(e.type==="image"&&(e.id==="cover-base"||e.id==="final-base"||typeof e.id=="string"&&e.id.startsWith("content-base-")))&&!(!e||e.type!=="image"&&e.type!=="text"||!e.content)){if(e.type==="image")try{const a=new Image;a.crossOrigin="anonymous",await new Promise((C,R)=>{a.onload=C,a.onerror=R,a.src=e.content});const h=((ae=e.position)==null?void 0:ae.x)!==void 0&&Math.abs(e.position.x)<=1,k=((_=e.position)==null?void 0:_.y)!==void 0&&Math.abs(e.position.y)<=1,S=((q=e.size)==null?void 0:q.width)!==void 0&&e.size.width<=1,N=((re=e.size)==null?void 0:re.height)!==void 0&&e.size.height<=1,j=h?e.position.x*s:((X=e.position)==null?void 0:X.x)||0,x=k?e.position.y*g:((le=e.position)==null?void 0:le.y)||0,v=S?e.size.width*s:((ee=e.size)==null?void 0:ee.width)||s,P=N?e.size.height*g:((G=e.size)==null?void 0:G.height)||g,b=w+j,u=f+x;console.log("üìê Renderizando elemento:",{elementId:e.id,cellId:t.id,cellPosition:{x:w,y:f,width:s,height:g},elementPosition:{x:j,y:x,width:v,height:P},finalPosition:{dx:b,dy:u},isRelative:{x:h,y:k,w:S,h:N},elementData:e}),V(d,a,b,u,v,P)}catch(a){console.error("Error al cargar imagen:",a,e)}else if(e.type==="text"){console.log("üî§ [THUMBNAIL] Procesando elemento de texto:",e.id,e.content),console.log("üî§ [THUMBNAIL] Datos completos del elemento:",JSON.stringify(e,null,2));try{const a=((te=e.position)==null?void 0:te.x)!==void 0&&Math.abs(e.position.x)<=1,h=((se=e.position)==null?void 0:se.y)!==void 0&&Math.abs(e.position.y)<=1,k=((oe=e.size)==null?void 0:oe.width)!==void 0&&e.size.width<=1,S=((ce=e.size)==null?void 0:ce.height)!==void 0&&e.size.height<=1;console.log("üî§ [THUMBNAIL] Es relativo:",{x:a,y:h,w:k,h:S});const N=a?e.position.x*s:((de=e.position)==null?void 0:de.x)||0,j=h?e.position.y*g:((ie=e.position)==null?void 0:ie.y)||0;let x,v;((ge=e.size)==null?void 0:ge.width)!==void 0?e.size.width<=1?x=e.size.width*s:x=e.size.width:x=s*.8,((he=e.size)==null?void 0:he.height)!==void 0?e.size.height<=1?v=e.size.height*g:v=e.size.height:v=g*.3;const P=w+N,b=f+j;console.log("üìê [THUMBNAIL] Renderizando texto:",{elementId:e.id,content:e.content,cellId:t.id,cellPosition:{x:w,y:f,width:s,height:g},elementPosition:{x:N,y:j,width:x,height:v},finalPosition:{dx:P,dy:b},isRelative:{x:a,y:h,w:k,h:S}}),(P<0||b<0||P>=m.width||b>=m.height)&&console.warn("‚ö†Ô∏è [THUMBNAIL] Texto fuera del canvas:",{dx:P,dy:b,canvasWidth:m.width,canvasHeight:m.height});const u=e.style||{};d.save();const C=parseInt(u.fontSize)||16,R=u.fontFamily||"Arial",A=u.fontWeight||"normal",U=u.fontStyle||"normal";d.font=`${A} ${U} ${C}px ${R}`,d.fillStyle=u.color||"#000000",d.textAlign=u.textAlign||"left",d.textBaseline="top",console.log("üî§ [THUMBNAIL] Configuraci√≥n de fuente:",{font:d.font,color:d.fillStyle,align:d.textAlign}),d.strokeStyle="#ff0000",d.lineWidth=2,d.strokeRect(P,b,x,v),console.log("üî§ [THUMBNAIL] Dibujando borde debug en:",{x:P,y:b,w:x,h:v}),u.backgroundColor&&u.backgroundColor!=="transparent"&&(d.fillStyle=u.backgroundColor,d.fillRect(P,b,x,v),d.fillStyle=u.color||"#000000");const H=e.content.split(`
`),J=C*1.2,W=parseInt(u.padding)||8;console.log("üî§ [THUMBNAIL] Preparando l√≠neas:",{lines:H,lineHeight:J,padding:W}),H.forEach((B,Z)=>{if(B.trim()){const D=P+W,O=b+Z*J+W;console.log(`üî§ [THUMBNAIL] Dibujando l√≠nea "${B}" en x=${D}, y=${O} con fuente=${d.font}`),console.log(`üî§ [THUMBNAIL] Color del texto: ${d.fillStyle}`),D>=0&&O>=0&&D<m.width&&O<m.height?(d.fillText(B,D,O),console.log(`‚úÖ [THUMBNAIL] L√≠nea "${B}" dibujada exitosamente`)):console.warn(`‚ö†Ô∏è [THUMBNAIL] L√≠nea "${B}" fuera del canvas:`,{textX:D,textY:O,canvasWidth:m.width,canvasHeight:m.height})}}),d.restore(),console.log("‚úÖ [THUMBNAIL] Texto renderizado exitosamente:",e.id)}catch(a){console.error("‚ùå [THUMBNAIL] Error renderizando texto:",a,e)}}}}}const $=document.createElement("canvas"),o=$.getContext("2d"),i=900;let c,n;m.width>m.height?(c=Math.min(i,m.width),n=c/m.width*m.height):(n=Math.min(i,m.height),c=n/m.height*m.width),c=Math.round(c),n=Math.round(n),$.width=c,$.height=n,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.webkitImageSmoothingEnabled=!0,o.mozImageSmoothingEnabled=!0,o.msImageSmoothingEnabled=!0,o.drawImage(E,0,0,E.width,E.height,0,0,c,n),M[p.id]=$.toDataURL("image/png",.92)}catch(E){console.error(`‚ùå Error generando thumbnail para p√°gina ${p.id}:`,E),M[p.id]=null}return M}export{Ye as B,Ve as g};
