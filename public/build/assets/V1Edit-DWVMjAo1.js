import{j as r}from"./AboutSimple-Cf8x2fCZ.js";import{r as V}from"./index-BH53Isel.js";import"./EditorLayout-3dTmWtvf.js";import"./EditorMain-rmOX089k.js";import{M as pe}from"./PaymentModal-Bxx5p2o_.js";import{H as Ie}from"./index.es-p8wkj5I3.js";import{G as he}from"./Global-ErywZRdd.js";import{l as Ne,g as Pe}from"./TextElement-t0TJofq8.js";import{X as be}from"./x-DBMwyD6F.js";import{C as Ae}from"./chevron-left-B2s3ZsB7.js";import{C as je}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./index-BSWw-p5k.js";import"./createLucideIcon-Cy5Ya80P.js";import"./copy-6OEekgvq.js";import"./trash-2-DK1wnsDn.js";const ye={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},Ce=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;pe.setAppElement("#app");const Xe=({isOpen:C,onRequestClose:g,pages:w,pageThumbnails:E={},addAlbumToCart:X,workspaceDimensions:F={width:800,height:600},layouts:Z=[],presetData:ne=null})=>{const[Q,ae]=V.useState(0),[_,J]=V.useState(!1),[re,D]=V.useState({}),[le,K]=V.useState(!1),G=V.useRef();function q(o,n,l,t,a,i){const h=n.width,b=n.height,N=a/i,e=h/b;let c=0,P=0,s=h,d=b;N>e?(d=h/N,P=(b-d)/2):(s=b*N,c=(h-s)/2),o.drawImage(n,c,P,s,d,l,t,a,i)}function se(o){const n=o.match(/grid-cols-(\d+)/),l=o.match(/grid-rows-(\d+)/),t=o.match(/gap-(\d+)/);return{cols:n?parseInt(n[1],10):1,rows:l?parseInt(l[1],10):1,gap:t?parseInt(t[1],10)*4:0}}function ee(o,n,l=1){const t=o&&o.match(new RegExp(`${n}-span-(\\d+)`));return t?parseInt(t[1],10):l}function ce(o,n,l){const{cols:t,rows:a,gap:i}=se(o.template),h=o.style&&o.style.padding?parseInt(o.style.padding):0,b=n.width-2*h,N=n.height-2*h,e=(b-i*(t-1))/t,c=(N-i*(a-1))/a,P=Array.from({length:a},()=>Array(t).fill(!1)),s={};for(let d=0;d<o.cells;d++){const $=o.cellStyles&&o.cellStyles[d]?o.cellStyles[d]:"",v=ee($,"col",1),p=ee($,"row",1);let x=!1;for(let f=0;f<=a-p&&!x;f++)for(let S=0;S<=t-v&&!x;S++){let O=!0;for(let A=f;A<f+p;A++){for(let I=S;I<S+v;I++)if(P[A][I]){O=!1;break}if(!O)break}if(O){for(let I=f;I<f+p;I++)for(let B=S;B<S+v;B++)P[I][B]=!0;const A=l&&l[d]?l[d].id:d;s[A]={x:h+S*(e+i),y:h+f*(c+i),width:e*v+i*(v-1),height:c*p+i*(p-1)},console.log(`[GRID-PLACEMENT] cellId:${A} col-span:${v} row-span:${p} => x:${s[A].x} y:${s[A].y} w:${s[A].width} h:${s[A].height}`),x=!0}}if(!x){const f=l&&l[d]?l[d].id:d;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${f}`),s[f]={x:0,y:0,width:e,height:c}}}return s}const de=V.useCallback(async()=>{if(!w||w.length===0||!C)return;console.log("üöÄ Iniciando generaci√≥n de thumbnails para BookPreview..."),K(!0),D({});const o={},n=4;for(let l=0;l<w.length;l++){const t=w[l],a=document.createElement("canvas"),i=a.getContext("2d");if(a.width=F.width*n,a.height=F.height*n,console.log(`üîß [THUMBNAIL] Generando thumbnail para p√°gina ${l} (${t.type})`),t.backgroundImage)try{const e=new Image;e.crossOrigin="anonymous",await new Promise((c,P)=>{e.onload=()=>{q(i,e,0,0,a.width,a.height),c()},e.onerror=()=>{i.fillStyle=t.backgroundColor||"#ffffff",i.fillRect(0,0,a.width,a.height),c()},e.src=t.backgroundImage})}catch{i.fillStyle=t.backgroundColor||"#ffffff",i.fillRect(0,0,a.width,a.height)}else i.fillStyle=t.backgroundColor||"#ffffff",i.fillRect(0,0,a.width,a.height);const h=Z.find(e=>e.id===t.layout);console.log(`üîß [THUMBNAIL] Looking for layout: ${t.layout}, found:`,!!h);let b={};if(h)b=ce(h,{width:F.width*n,height:F.height*n},t.cells);else{console.warn(`‚ö†Ô∏è [THUMBNAIL] Layout not found for page ${l}:`,t.layout);for(const e of t.cells)b[e.id]={x:0,y:0,width:F.width*n,height:F.height*n}}for(const e of t.cells){const c=b[e.id];if(!c){console.warn(`‚ö†Ô∏è [THUMBNAIL] Cell position not found for cell: ${e.id}`);continue}console.log(`üîß [THUMBNAIL] Processing cell ${e.id} with ${e.elements.length} elements`);const P=e.elements.sort((s,d)=>(s.zIndex||0)-(d.zIndex||0));for(const s of P){console.log(`üîß [THUMBNAIL] Drawing element ${s.id} (${s.type}): "${s.content}"`);const d=s.position||{x:0,y:0},$=c.x/n,v=c.y/n,p=c.width/n,x=c.height/n,f=d.x!==void 0&&Math.abs(d.x)<=1,S=d.y!==void 0&&Math.abs(d.y)<=1,O=f?d.x*p:d.x||0,A=S?d.y*x:d.y||0,I=$+O,B=v+A;if(s.type==="image"&&s.content)try{const U=new Image;U.crossOrigin="anonymous",await new Promise((y,k)=>{U.onload=()=>{const j=s.size||{},oe=j.width!==void 0&&j.width<=1,H=j.height!==void 0&&j.height<=1,W=oe?j.width*p:j.width||p*.8,ge=H?j.height*x:j.height||x*.8;q(i,U,I*n,B*n,W*n,ge*n),console.log(`‚úÖ [THUMBNAIL] Image element drawn: ${s.id} at (${I}, ${B}) size (${W}, ${ge})`),y()},U.onerror=()=>{console.error("‚ùå [THUMBNAIL] Failed to load image element:",s.content),y()},U.src=s.content})}catch(U){console.error("‚ùå [THUMBNAIL] Error loading image element:",U)}else if(s.type==="text"&&s.content){console.log(`üîß [THUMBNAIL] Drawing text element: "${s.content}" at relative pos (${d.x}, ${d.y})`);const U=s.style||{};U.fontFamily&&await Ne(U.fontFamily);const y=Pe(U,n);i.save(),i.font=`${y.fontWeight} ${y.fontStyle} ${y.fontSize} ${y.fontFamily}`,i.fillStyle=y.color,i.textAlign=y.textAlign,i.textBaseline="top";const k=s.size||{},j=k.width!==void 0&&k.width<=1,oe=k.height!==void 0&&k.height<=1,H=j?k.width*p:k.width||p*.8,W=oe?k.height*x:k.height||x*.3;y.backgroundColor!=="transparent"&&(i.fillStyle=y.backgroundColor,i.fillRect(I*n,B*n,H*n,W*n),i.fillStyle=y.color);const ge=s.content.split(`
`),xe=parseInt(y.fontSize)*parseFloat(y.lineHeight);ge.forEach((me,we)=>{if(me.trim()){let ie,fe;const ue=I*n,ve=B*n+we*xe;switch(y.textAlign){case"center":ie=ue+H*n/2;break;case"right":ie=ue+H*n-(y.padding||0);break;default:ie=ue+(y.padding||0);break}fe=ve+(y.padding||0),console.log(`üîß [THUMBNAIL] Drawing line "${me}" at x=${ie}, y=${fe}, align=${y.textAlign}`),i.fillText(me,ie,fe)}}),i.restore(),console.log(`‚úÖ [THUMBNAIL] Text element drawn: ${s.id} at (${I}, ${B}) size (${H}, ${W})`)}}}const N=a.toDataURL("image/jpeg",.9);console.log(`üéØ [THUMBNAIL] Generated thumbnail for page ${l}`),o[l]=N}D(o),K(!1)},[w,C,F,Z,ne]);V.useEffect(()=>{C&&(Object.keys(E).length===0?de():D(E))},[C,E]),V.useEffect(()=>{C||D({})},[C]);const te=Object.keys(E).length>0?E:re;if(!w||!Array.isArray(w)||w.length===0)return r.jsx(pe,{isOpen:C,onRequestClose:g,style:ye,contentLabel:"Vista previa del √°lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:r.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[r.jsxs("div",{className:"flex justify-between items-center mb-4",children:[r.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del √°lbum"}),r.jsx("button",{onClick:g,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:r.jsx(be,{size:24})})]}),r.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay p√°ginas disponibles para mostrar."})]})});const u=()=>{G.current&&G.current.pageFlip().flipPrev()},T=()=>{G.current&&G.current.pageFlip().flipNext()},m=F.width/F.height,L=600,M=Math.round(L*m),z=(()=>{const o=[],n=[...w.filter(t=>t.type==="cover"),...w.filter(t=>t.type==="content"),...w.filter(t=>t.type==="final")];n.length>0&&(o.push(n[0]),o.push({...n[0],isBack:!0}));for(let t=1;t<n.length-1;t++)o.push(n[t]),t+1<n.length-1?(o.push(n[t+1]),t++):o.push({...n[t],isBack:!0,isEmpty:!0});const l=n.find(t=>t.type==="final");return l&&(o.push({...l,isBack:!0,isEmpty:!0}),o.push(l)),o})();return r.jsxs(pe,{isOpen:C,onRequestClose:g,style:ye,contentLabel:"Vista previa del √°lbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[r.jsx("style",{dangerouslySetInnerHTML:{__html:Ce}}),le&&r.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:r.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),r.jsx("p",{className:"text-gray-700",children:"Generando vistas previas de alta calidad..."}),r.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),r.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[r.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del √°lbum"}),r.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las p√°ginas de su √°lbum usando los controles de navegaci√≥n o teclado. Puede cerrar esta ventana presionando Escape o el bot√≥n de cerrar."}),r.jsx("button",{onClick:g,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del √°lbum",children:r.jsx(be,{className:"h-6 w-6"})}),r.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[r.jsx("button",{onClick:u,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"P√°gina anterior",children:r.jsx(Ae,{className:"h-6 w-6"})}),r.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const o=z[Q];return o?o.isBack&&o.isEmpty?"Reverso":o.isBack?"Reverso de la p√°gina":o.type==="cover"?"Portada":o.type==="final"?"Contraportada":`P√°gina ${o.pageNumber||Math.ceil((Q+1)/2)}`:"Cargando..."})(),r.jsx("span",{className:"mx-2 text-gray-400",children:"‚Ä¢"}),Math.ceil((Q+1)/2)," / ",Math.ceil(z.length/2)," hojas"]}),r.jsx("button",{onClick:T,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"P√°gina siguiente",children:r.jsx(je,{className:"h-6 w-6"})})]}),r.jsx("div",{className:"flex items-center justify-center",children:r.jsx(Ie,{ref:G,width:M,height:L,size:"stretch",minWidth:M*.7,maxWidth:M*1.3,minHeight:L*.7,maxHeight:L*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:o=>ae(o.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:z.map((o,n)=>r.jsx("div",{id:`page-${o.id}`,className:"page-container",style:{width:M,height:L,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:r.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:o.isEmpty||o.isBack?r.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:o.isBack?"Reverso":""}):te[o.id]?r.jsx("img",{src:te[o.id],alt:`${o.type==="cover"?"Portada":o.type==="final"?"Contraportada":`P√°gina ${o.pageNumber||n+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):r.jsx(Ee,{page:o,pageIdx:n})})},`page-${n}`))})})]}),r.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-md mx-auto",children:[r.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${_?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var o,n,l;if(!_){J(!0);try{if(console.log("üöÄ Iniciando proceso de compra con generaci√≥n de PDF..."),typeof X!="function"){console.error("‚ùå addAlbumToCart no es una funci√≥n"),console.log("addAlbumToCart type:",typeof X),console.log("addAlbumToCart value:",X),alert("Error: Funci√≥n de carrito no disponible. Int√©ntelo nuevamente.");return}if(typeof window.finalizeAlbumDesign=="function"){console.log("üìÑ Finalizando dise√±o del √°lbum...");const t=await window.finalizeAlbumDesign();if(console.log("üìÑ Resultado de finalizeAlbumDesign:",t),t){if(console.log("üìÑ Generando PDF del √°lbum..."),typeof window.generateAlbumPDF=="function")try{const i=await window.generateAlbumPDF();console.log("üìÑ PDF generado exitosamente:",i),console.log("üíæ Guardando PDF en el servidor...");const h=window.currentAlbumUuid||window.albumUuid;if(!h)throw new Error("No se encontr√≥ el UUID del √°lbum");const b=await new Promise((c,P)=>{const s=new FileReader;s.onload=()=>{const d=s.result.split(",")[1];c(d)},s.onerror=P,s.readAsDataURL(i)}),N=await fetch(`/api/albums/${h}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content"))||""},body:JSON.stringify({pdf_blob:b})});if(!N.ok){const c=await N.json();throw new Error(c.message||"Error al guardar el PDF en el servidor")}const e=await N.json();console.log("üíæ PDF guardado en servidor:",e)}catch(i){console.error("‚ùå Error generando/guardando PDF:",i),console.log("‚ö†Ô∏è Continuando sin PDF...")}else console.warn("‚ö†Ô∏è window.generateAlbumPDF no est√° disponible, continuando sin PDF...");console.log("üì¶ Agregando √°lbum al carrito...");const a=X();if(console.log("üì¶ Resultado de addAlbumToCart:",a),a){console.log("‚úÖ √Ålbum agregado al carrito exitosamente");try{await new Promise(b=>setTimeout(b,200));const i=JSON.parse(localStorage.getItem(`${((n=window.Global)==null?void 0:n.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");console.log("üîç Verificaci√≥n final del carrito:",i),console.log("üîç Longitud del carrito:",i.length),i.length===0&&console.error("‚ùå ADVERTENCIA: El carrito parece vac√≠o despu√©s de agregar");const h=`${he.APP_URL}/cart`;console.log("üîÑ Redirigiendo al carrito..."),console.log("üîÑ URL del carrito:",h),window.location.href=h}catch(i){console.error("‚ö†Ô∏è Error durante verificaci√≥n o redirecci√≥n:",i),console.log("üîÑ Intentando redirecci√≥n directa...");const h=`${he.APP_URL}/cart`;console.log("üîÑ Redirigiendo al carrito..."),console.log("üîÑ URL del carrito:",h),window.location.href=h}}else console.error("‚ùå No se pudo agregar al carrito"),alert("Error al agregar el √°lbum al carrito. Revise la consola para m√°s detalles.")}else console.error("‚ùå No se pudo finalizar el dise√±o del √°lbum"),alert("Error al finalizar el dise√±o del √°lbum. Int√©ntelo nuevamente.")}else console.error("‚ùå window.finalizeAlbumDesign no est√° disponible"),alert("Funcionalidad de finalizaci√≥n de dise√±o pendiente de implementar.")}catch(t){console.error("‚ùå === ERROR DURANTE PROCESO DE COMPRA ==="),console.error("Tipo de error:",t.name),console.error("Mensaje:",t.message),console.error("Stack trace:",t.stack),console.error("Error completo:",t);try{const a=JSON.parse(localStorage.getItem(`${((l=he)==null?void 0:l.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");if(console.log("üîç Verificando carrito despu√©s del error:",a.length>0?"HAY ITEMS":"VAC√çO"),a.length>0){console.log("‚úÖ El carrito tiene items, redirigiendo de todas formas...");const i=`${he.APP_URL}/cart`;console.log("üîÑ Redirigiendo al carrito..."),console.log("üîÑ URL del carrito:",i),window.location.href=i;return}}catch(a){console.error("‚ùå Error durante intento de recuperaci√≥n:",a)}alert(`Error durante el proceso: ${t.message}. Si el √°lbum se agreg√≥ al carrito, puede ir manualmente a la p√°gina del carrito.`)}finally{J(!1)}}},disabled:_,children:_?r.jsxs(r.Fragment,{children:[r.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[r.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),r.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),r.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:g,disabled:_,children:"Continuar editando"})]}),"        "]})},Ee=({page:C,pageIdx:g})=>{let w="",E="";switch(C.type){case"cover":w="Portada",E="üìö";break;case"final":w="Contraportada",E="üìñ";break;case"content":w=`P√°gina ${C.pageNumber||g+1}`,E="üìÑ";break;default:w=`P√°gina ${g+1}`,E="üìÑ"}return r.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[r.jsx("div",{className:"text-6xl mb-4",children:E}),r.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:w}),r.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),C.layout&&r.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",C.layout.name||"Personalizado"]})]})};async function De({pages:C,workspaceDimensions:g,presetData:w}){var F,Z,ne,Q,ae,_,J,re,D,le,K,G,q,se,ee,ce,de,te;const E={};function X(u,T,m,Y,L,M){if(!T||!u){console.warn("‚ö†Ô∏è No se puede dibujar: contexto o imagen no v√°lidos");return}const R=T.width,z=T.height;if(R===0||z===0){console.warn("‚ö†Ô∏è Imagen con dimensiones cero:",{sWidth:R,sHeight:z});return}if(L<=0||M<=0){console.warn("‚ö†Ô∏è Dimensiones de destino inv√°lidas:",{dWidth:L,dHeight:M});return}const o=L/M,n=R/z;let l,t,a,i;o>n?(a=R,i=a/o,l=0,t=(z-i)/2):(i=z,a=i*o,l=(R-a)/2,t=0);try{u.save(),u.imageSmoothingQuality="high",u.drawImage(T,Math.max(0,l),Math.max(0,t),Math.min(a,R-l),Math.min(i,z-t),m,Y,L,M),u.restore()}catch(h){console.error("‚ùå Error al dibujar imagen:",h),console.error("Detalles:",{source:{x:l,y:t,width:a,height:i},dest:{x:m,y:Y,width:L,height:M},imgSize:{width:R,height:z}})}}for(const u of C)try{const T=document.createElement("canvas"),m=T.getContext("2d",{willReadFrequently:!0});T.width=g.width,T.height=g.height,m.scale(1,1),m.imageSmoothingEnabled=!0,m.imageSmoothingQuality="high",m.textRendering="geometricPrecision",m.webkitImageSmoothingEnabled=!0,m.mozImageSmoothingEnabled=!0,m.msImageSmoothingEnabled=!0,console.log("üñºÔ∏è [THUMBNAIL] Generando miniatura para p√°gina:",u==null?void 0:u.type),console.log("üñºÔ∏è [THUMBNAIL] backgroundImage:",u==null?void 0:u.backgroundImage),console.log("üñºÔ∏è [THUMBNAIL] backgroundColor:",u==null?void 0:u.backgroundColor);let Y=u.backgroundImage,L=u.backgroundColor||"#ffffff";if(console.log("üñºÔ∏è [THUMBNAIL] URL final:",Y),console.log("üé® [THUMBNAIL] Color final:",L),m.fillStyle=L,m.fillRect(0,0,g.width,g.height),Y){console.log("üñºÔ∏è [THUMBNAIL] Cargando imagen de fondo:",Y);try{const l=new window.Image;l.crossOrigin="anonymous",l.src=Y,await new Promise((t,a)=>{if(l.complete)return console.log("‚úÖ [THUMBNAIL] Imagen ya cargada"),t();l.onload=()=>{console.log("‚úÖ [THUMBNAIL] Imagen cargada exitosamente"),t()},l.onerror=i=>{console.error("‚ùå [THUMBNAIL] Error cargando imagen:",i),a(i)}}),X(m,l,0,0,g.width,g.height),console.log("‚úÖ [THUMBNAIL] Imagen de fondo dibujada")}catch(l){console.error("‚ùå [THUMBNAIL] Error procesando imagen de fondo:",l)}}else console.log("‚ÑπÔ∏è [THUMBNAIL] Sin imagen de fondo, usando solo color");if(u.cells&&Array.isArray(u.cells)){const l=[...u.cells].sort((t,a)=>{var b,N,e,c;const i=((b=t.position)==null?void 0:b.y)||0,h=((N=a.position)==null?void 0:N.y)||0;return i!==h?i-h:(((e=t.position)==null?void 0:e.x)||0)-(((c=a.position)==null?void 0:c.x)||0)});for(const t of l){if(!t||!t.elements)continue;const a=((F=t.size)==null?void 0:F.width)||g.width,i=((Z=t.size)==null?void 0:Z.height)||g.height,h=((ne=t.position)==null?void 0:ne.x)||0,b=((Q=t.position)==null?void 0:Q.y)||0;t.size||console.warn("‚ö†Ô∏è cell.size no definido, usando tama√±o workspace",t);const N=[...t.elements||[]].sort((e,c)=>(e.zIndex||0)-(c.zIndex||0));for(const e of N)if(!(e.type==="image"&&(e.id==="cover-base"||e.id==="final-base"||typeof e.id=="string"&&e.id.startsWith("content-base-")))&&!(!e||e.type!=="image"&&e.type!=="text"||!e.content)){if(e.type==="image")try{const c=new Image;c.crossOrigin="anonymous",await new Promise((A,I)=>{c.onload=A,c.onerror=I,c.src=e.content});const P=((ae=e.position)==null?void 0:ae.x)!==void 0&&Math.abs(e.position.x)<=1,s=((_=e.position)==null?void 0:_.y)!==void 0&&Math.abs(e.position.y)<=1,d=((J=e.size)==null?void 0:J.width)!==void 0&&e.size.width<=1,$=((re=e.size)==null?void 0:re.height)!==void 0&&e.size.height<=1,v=P?e.position.x*a:((D=e.position)==null?void 0:D.x)||0,p=s?e.position.y*i:((le=e.position)==null?void 0:le.y)||0,x=d?e.size.width*a:((K=e.size)==null?void 0:K.width)||a,f=$?e.size.height*i:((G=e.size)==null?void 0:G.height)||i,S=h+v,O=b+p;console.log("üìê Renderizando elemento:",{elementId:e.id,cellId:t.id,cellPosition:{x:h,y:b,width:a,height:i},elementPosition:{x:v,y:p,width:x,height:f},finalPosition:{dx:S,dy:O},isRelative:{x:P,y:s,w:d,h:$},elementData:e}),X(m,c,S,O,x,f)}catch(c){console.error("Error al cargar imagen:",c,e)}else if(e.type==="text"){console.log("üî§ [THUMBNAIL] Procesando elemento de texto:",e.id,e.content);try{const c=((q=e.position)==null?void 0:q.x)!==void 0&&Math.abs(e.position.x)<=1,P=((se=e.position)==null?void 0:se.y)!==void 0&&Math.abs(e.position.y)<=1,s=c?e.position.x*a:((ee=e.position)==null?void 0:ee.x)||0,d=P?e.position.y*i:((ce=e.position)==null?void 0:ce.y)||0;let $,v;((de=e.size)==null?void 0:de.width)!==void 0?e.size.width<=1?$=e.size.width*a:$=e.size.width:$=a*.8,((te=e.size)==null?void 0:te.height)!==void 0?e.size.height<=1?v=e.size.height*i:v=e.size.height:v=i*.3;const p=h+s,x=b+d;console.log("üìê [THUMBNAIL] Renderizando texto:",{elementId:e.id,content:e.content,cellPosition:{x:h,y:b,width:a,height:i},elementPosition:{x:s,y:d,width:$,height:v},finalPosition:{dx:p,dy:x},isRelative:{x:c,y:P}}),(p<0||x<0||p>=g.width||x>=g.height)&&console.warn("‚ö†Ô∏è [THUMBNAIL] Texto fuera del canvas:",{dx:p,dy:x,canvasWidth:g.width,canvasHeight:g.height});const f=e.style||{};m.save();const S=parseInt(f.fontSize)||16,O=f.fontFamily||"Arial",A=f.fontWeight||"normal",I=f.fontStyle||"normal";m.font=`${A} ${I} ${S}px ${O}`,m.fillStyle=f.color||"#000000";const B=f.textAlign||"left";m.textAlign=B,m.textBaseline="top",console.log("üî§ [THUMBNAIL] Configuraci√≥n de fuente:",{font:m.font,color:m.fillStyle,align:B}),f.backgroundColor&&f.backgroundColor!=="transparent"&&(m.fillStyle=f.backgroundColor,m.fillRect(p,x,$,v),m.fillStyle=f.color||"#000000");const U=e.content.split(`
`),y=S*1.2,k=parseInt(f.padding)||8;console.log("üî§ [THUMBNAIL] Preparando l√≠neas:",{lines:U,lineHeight:y,padding:k}),U.forEach((j,oe)=>{if(j.trim()){let H,W;switch(W=x+oe*y+k,B){case"center":H=p+$/2;break;case"right":H=p+$-k;break;case"left":default:H=p+k;break}console.log(`üî§ [THUMBNAIL] Dibujando l√≠nea "${j}" en x=${H}, y=${W} con alineaci√≥n=${B}`),H>=0&&W>=0&&H<g.width&&W<g.height?(m.fillText(j,H,W),console.log(`‚úÖ [THUMBNAIL] L√≠nea "${j}" dibujada exitosamente`)):console.warn(`‚ö†Ô∏è [THUMBNAIL] L√≠nea "${j}" fuera del canvas:`,{textX:H,textY:W,canvasWidth:g.width,canvasHeight:g.height})}}),m.restore(),console.log("‚úÖ [THUMBNAIL] Texto renderizado exitosamente:",e.id)}catch(c){console.error("‚ùå [THUMBNAIL] Error renderizando texto:",c,e)}}}}}const M=document.createElement("canvas"),R=M.getContext("2d"),z=900;let o,n;g.width>g.height?(o=Math.min(z,g.width),n=o/g.width*g.height):(n=Math.min(z,g.height),o=n/g.height*g.width),o=Math.round(o),n=Math.round(n),M.width=o,M.height=n,R.imageSmoothingEnabled=!0,R.imageSmoothingQuality="high",R.webkitImageSmoothingEnabled=!0,R.mozImageSmoothingEnabled=!0,R.msImageSmoothingEnabled=!0,R.drawImage(T,0,0,T.width,T.height,0,0,o,n),E[u.id]=M.toDataURL("image/png",.92)}catch(T){console.error(`‚ùå Error generando thumbnail para p√°gina ${u.id}:`,T),E[u.id]=null}return E}export{Xe as B,De as g};
