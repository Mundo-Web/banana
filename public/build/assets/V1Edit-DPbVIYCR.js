import{j as i}from"./AboutSimple-Cf8x2fCZ.js";import{r as U}from"./index-BH53Isel.js";import"./EditorLayout-BCylU6V-.js";import{M as re}from"./PaymentModal-Bxx5p2o_.js";import{H as le}from"./index.es-p8wkj5I3.js";import{G as te}from"./Global-ErywZRdd.js";import{X as ne}from"./x-DBMwyD6F.js";import{C as se}from"./chevron-left-B2s3ZsB7.js";import{C as ce}from"./chevron-right-Ckt5D2ka.js";import"./index-yBjzXJbu.js";import"./index-fNjTmf9T.js";import"./index-Chjiymov.js";import"./createLucideIcon-Cy5Ya80P.js";const ae={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)",padding:"0",border:"none",background:"none",overflow:"visible"},overlay:{backgroundColor:"rgba(0, 0, 0, 0.8)",zIndex:1e3}},de=`
    .stf__wrapper {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__block {
        margin: 0 !important;
        padding: 0 !important;
    }
    .stf__page {
        margin: 0 !important;
        padding: 0 !important;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
    }
    .page-container img {
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        outline: none;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: high-quality !important;
        -webkit-backface-visibility: hidden !important;
        backface-visibility: hidden !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        -ms-interpolation-mode: bicubic !important;
    }
    .page-container {
        -webkit-font-smoothing: subpixel-antialiased !important;
        -moz-osx-font-smoothing: auto !important;
    }
`;re.setAppElement("#app");const Ce=({isOpen:P,onRequestClose:c,pages:n,pageThumbnails:j={},addAlbumToCart:O,workspaceDimensions:$={width:800,height:600},layouts:Q=[],presetData:H=null})=>{const[Y,K]=U.useState(0),[L,Z]=U.useState(!1),[q,W]=U.useState({}),[D,J]=U.useState(!1),B=U.useRef();function x(e,r,t,o,f,d){const a=r.width,g=r.height,m=f/d,y=a/g;let b=0,I=0,h=a,l=g;m>y?(l=a/m,I=(g-l)/2):(h=g*m,b=(a-h)/2),e.drawImage(r,b,I,h,l,t,o,f,d)}function E(e){const r=e.match(/grid-cols-(\d+)/),t=e.match(/grid-rows-(\d+)/),o=e.match(/gap-(\d+)/);return{cols:r?parseInt(r[1],10):1,rows:t?parseInt(t[1],10):1,gap:o?parseInt(o[1],10)*4:0}}function p(e,r,t=1){const o=e&&e.match(new RegExp(`${r}-span-(\\d+)`));return o?parseInt(o[1],10):t}function k(e,r,t){const{cols:o,rows:f,gap:d}=E(e.template),a=e.style&&e.style.padding?parseInt(e.style.padding):0,g=r.width-2*a,m=r.height-2*a,y=(g-d*(o-1))/o,b=(m-d*(f-1))/f,I=Array.from({length:f},()=>Array(o).fill(!1)),h={};for(let l=0;l<e.cells;l++){const F=e.cellStyles&&e.cellStyles[l]?e.cellStyles[l]:"",z=p(F,"col",1),X=p(F,"row",1);let ee=!1;for(let M=0;M<=f-X&&!ee;M++)for(let V=0;V<=o-z&&!ee;V++){let oe=!0;for(let T=M;T<M+X;T++){for(let G=V;G<V+z;G++)if(I[T][G]){oe=!1;break}if(!oe)break}if(oe){for(let G=M;G<M+X;G++)for(let ie=V;ie<V+z;ie++)I[G][ie]=!0;const T=t&&t[l]?t[l].id:l;h[T]={x:a+V*(y+d),y:a+M*(b+d),width:y*z+d*(z-1),height:b*X+d*(X-1)},console.log(`[GRID-PLACEMENT] cellId:${T} col-span:${z} row-span:${X} => x:${h[T].x} y:${h[T].y} w:${h[T].width} h:${h[T].height}`),ee=!0}}if(!ee){const M=t&&t[l]?t[l].id:l;console.warn(`[GRID-PLACEMENT] No se pudo ubicar la celda ${M}`),h[M]={x:0,y:0,width:y,height:b}}}return h}const S=U.useCallback(async()=>{if(!n||n.length===0||!P)return;console.log("🚀 Iniciando generación de thumbnails para BookPreview..."),J(!0),W({});const e={},r=4,t=(a,g,m,y)=>{if(!g||!g.image)return;const b=new Image;b.src=g.image,b.onload=()=>{const I=m.x+g.x*y,h=m.y+g.y*y,l=g.width*y,F=g.height*y;x(a,b,I,h,l,F)}},o=async(a,g)=>{const m=document.createElement("canvas"),y=m.getContext("2d");if(m.width=$.width*r,m.height=$.height*r,H&&H.final_layer_image){const l=new Image;l.src=H.final_layer_image,l.onload=()=>{y.drawImage(l,0,0,m.width,m.height)}}const b=Q.find(l=>l.id===a.layoutId);if(!b)return;const I=k(b,$,a.cells);a.cells.forEach(l=>{const F=I[l.id];F&&l.elements.forEach(z=>{t(y,z,F,r)})});const h=m.toDataURL("image/jpeg",.9);return{[g]:h}},f=n.map((a,g)=>o(a,g));(await Promise.all(f)).forEach(a=>{Object.assign(e,a)}),W(e),J(!1)},[n,P,$,Q,H]);U.useEffect(()=>{P&&(Object.keys(j).length===0?S():W(j))},[P,j]),U.useEffect(()=>{P||W({})},[P]);const C=Object.keys(j).length>0?j:q;if(!n||!Array.isArray(n)||n.length===0)return i.jsx(re,{isOpen:P,onRequestClose:c,style:ae,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:i.jsxs("div",{className:"bg-white p-8 rounded-lg shadow-lg max-w-md mx-auto",children:[i.jsxs("div",{className:"flex justify-between items-center mb-4",children:[i.jsx("h2",{id:"modal-title",className:"text-xl font-bold",children:"Vista previa del álbum"}),i.jsx("button",{onClick:c,className:"text-gray-500 hover:text-gray-700","aria-label":"Cerrar vista previa",children:i.jsx(ne,{size:24})})]}),i.jsx("p",{id:"modal-description",className:"text-gray-600",children:"No hay páginas disponibles para mostrar."})]})});const _=()=>{B.current&&B.current.pageFlip().flipPrev()},w=()=>{B.current&&B.current.pageFlip().flipNext()},R=$.width/$.height,s=600,u=Math.round(s*R),v=(()=>{const e=[],r=[...n.filter(o=>o.type==="cover"),...n.filter(o=>o.type==="content"),...n.filter(o=>o.type==="final")];r.length>0&&(e.push(r[0]),e.push({...r[0],isBack:!0}));for(let o=1;o<r.length-1;o++)e.push(r[o]),o+1<r.length-1?(e.push(r[o+1]),o++):e.push({...r[o],isBack:!0,isEmpty:!0});const t=r.find(o=>o.type==="final");return t&&(e.push({...t,isBack:!0,isEmpty:!0}),e.push(t)),e})();return i.jsxs(re,{isOpen:P,onRequestClose:c,style:ae,contentLabel:"Vista previa del álbum",ariaHideApp:!0,shouldCloseOnOverlayClick:!0,shouldCloseOnEsc:!0,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title","aria-describedby":"modal-description",children:[i.jsx("style",{dangerouslySetInnerHTML:{__html:de}}),D&&i.jsx("div",{className:"absolute inset-0 bg-black/50 flex items-center justify-center z-50",children:i.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl flex flex-col items-center",children:[i.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mb-4"}),i.jsx("p",{className:"text-gray-700",children:"Generando vistas previas de alta calidad..."}),i.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Esto puede tomar unos segundos"})]})}),i.jsxs("div",{className:"relative flex flex-col items-center justify-center p-6 bg-white rounded-2xl shadow-2xl",children:[i.jsx("h2",{id:"modal-title",className:"sr-only",children:"Vista previa del álbum"}),i.jsx("p",{id:"modal-description",className:"sr-only",children:"Navegue por las páginas de su álbum usando los controles de navegación o teclado. Puede cerrar esta ventana presionando Escape o el botón de cerrar."}),i.jsx("button",{onClick:c,className:"absolute top-4 right-4 p-2 rounded-full bg-white/80 hover:bg-white text-gray-700 shadow z-10","aria-label":"Cerrar vista previa del álbum",children:i.jsx(ne,{className:"h-6 w-6"})}),i.jsxs("div",{className:"flex items-center justify-center gap-8 mb-6 mt-2",children:[i.jsx("button",{onClick:_,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página anterior",children:i.jsx(se,{className:"h-6 w-6"})}),i.jsxs("span",{className:"flex items-center text-gray-700 text-base font-medium px-4 py-2 bg-gray-50 rounded-lg","aria-live":"polite",children:[(()=>{const e=v[Y];return e?e.isBack&&e.isEmpty?"Reverso":e.isBack?"Reverso de la página":e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`Página ${e.pageNumber||Math.ceil((Y+1)/2)}`:"Cargando..."})(),i.jsx("span",{className:"mx-2 text-gray-400",children:"•"}),Math.ceil((Y+1)/2)," / ",Math.ceil(v.length/2)," hojas"]}),i.jsx("button",{onClick:w,className:"p-3 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 shadow transition-colors","aria-label":"Página siguiente",children:i.jsx(ce,{className:"h-6 w-6"})})]}),i.jsx("div",{className:"flex items-center justify-center",children:i.jsx(le,{ref:B,width:u,height:s,size:"stretch",minWidth:u*.7,maxWidth:u*1.3,minHeight:s*.7,maxHeight:s*1.3,maxShadowOpacity:.3,showCover:!0,mobileScrollSupport:!0,onFlip:e=>K(e.data),className:"shadow-xl",usePortrait:!1,startPage:0,drawShadow:!0,flippingTime:600,useMouseEvents:!0,swipeDistance:50,showPageCorners:!0,disableFlipByClick:!1,style:{margin:0,padding:0},children:v.map((e,r)=>i.jsx("div",{id:`page-${e.id}`,className:"page-container",style:{width:u,height:s,margin:0,padding:0,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#ffffff"},children:i.jsx("div",{style:{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:e.isEmpty||e.isBack?i.jsx("div",{className:"flex items-center justify-center text-gray-300 text-xs",style:{width:"100%",height:"100%",backgroundColor:"#ffffff",border:"1px solid #f0f0f0"},children:e.isBack?"Reverso":""}):C[e.id]?i.jsx("img",{src:C[e.id],alt:`${e.type==="cover"?"Portada":e.type==="final"?"Contraportada":`Página ${e.pageNumber||r+1}`}`,style:{width:"100%",height:"100%",objectFit:"contain",margin:0,padding:0,border:"none",imageRendering:"auto",backgroundColor:"#ffffff",WebkitBackfaceVisibility:"hidden",backfaceVisibility:"hidden",WebkitTransform:"translateZ(0)",transform:"translateZ(0)"}}):i.jsx(ge,{page:e,pageIdx:r})})},`page-${r}`))})})]}),i.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mt-6 w-full max-w-md mx-auto",children:[i.jsx("button",{className:`flex-1 py-3 px-4 rounded-lg font-semibold shadow transition flex items-center justify-center ${L?"bg-purple-400 text-white cursor-not-allowed":"bg-purple-600 text-white hover:bg-purple-700"}`,onClick:async()=>{var e,r,t;if(!L){Z(!0);try{if(console.log("🚀 Iniciando proceso de compra con generación de PDF..."),typeof O!="function"){console.error("❌ addAlbumToCart no es una función"),console.log("addAlbumToCart type:",typeof O),console.log("addAlbumToCart value:",O),alert("Error: Función de carrito no disponible. Inténtelo nuevamente.");return}if(typeof window.finalizeAlbumDesign=="function"){console.log("📄 Finalizando diseño del álbum...");const o=await window.finalizeAlbumDesign();if(console.log("📄 Resultado de finalizeAlbumDesign:",o),o){if(console.log("📄 Generando PDF del álbum..."),typeof window.generateAlbumPDF=="function")try{const d=await window.generateAlbumPDF();console.log("📄 PDF generado exitosamente:",d),console.log("💾 Guardando PDF en el servidor...");const a=window.currentAlbumUuid||window.albumUuid;if(!a)throw new Error("No se encontró el UUID del álbum");const g=await new Promise((b,I)=>{const h=new FileReader;h.onload=()=>{const l=h.result.split(",")[1];b(l)},h.onerror=I,h.readAsDataURL(d)}),m=await fetch(`/api/albums/${a}/generate-pdf`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"))||""},body:JSON.stringify({pdf_blob:g})});if(!m.ok){const b=await m.json();throw new Error(b.message||"Error al guardar el PDF en el servidor")}const y=await m.json();console.log("💾 PDF guardado en servidor:",y)}catch(d){console.error("❌ Error generando/guardando PDF:",d),console.log("⚠️ Continuando sin PDF...")}else console.warn("⚠️ window.generateAlbumPDF no está disponible, continuando sin PDF...");console.log("📦 Agregando álbum al carrito...");const f=O();if(console.log("📦 Resultado de addAlbumToCart:",f),f){console.log("✅ Álbum agregado al carrito exitosamente");try{await new Promise(g=>setTimeout(g,200));const d=JSON.parse(localStorage.getItem(`${((r=window.Global)==null?void 0:r.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");console.log("🔍 Verificación final del carrito:",d),console.log("🔍 Longitud del carrito:",d.length),d.length===0&&console.error("❌ ADVERTENCIA: El carrito parece vacío después de agregar");const a=`${te.APP_URL}/cart`;console.log("🔄 Redirigiendo al carrito..."),console.log("🔄 URL del carrito:",a),window.location.href=a}catch(d){console.error("⚠️ Error durante verificación o redirección:",d),console.log("🔄 Intentando redirección directa...");const a=`${te.APP_URL}/cart`;console.log("🔄 Redirigiendo al carrito..."),console.log("🔄 URL del carrito:",a),window.location.href=a}}else console.error("❌ No se pudo agregar al carrito"),alert("Error al agregar el álbum al carrito. Revise la consola para más detalles.")}else console.error("❌ No se pudo finalizar el diseño del álbum"),alert("Error al finalizar el diseño del álbum. Inténtelo nuevamente.")}else console.error("❌ window.finalizeAlbumDesign no está disponible"),alert("Funcionalidad de finalización de diseño pendiente de implementar.")}catch(o){console.error("❌ === ERROR DURANTE PROCESO DE COMPRA ==="),console.error("Tipo de error:",o.name),console.error("Mensaje:",o.message),console.error("Stack trace:",o.stack),console.error("Error completo:",o);try{const f=JSON.parse(localStorage.getItem(`${((t=te)==null?void 0:t.APP_CORRELATIVE)||"bananalab"}_cart`)||"[]");if(console.log("🔍 Verificando carrito después del error:",f.length>0?"HAY ITEMS":"VACÍO"),f.length>0){console.log("✅ El carrito tiene items, redirigiendo de todas formas...");const d=`${te.APP_URL}/cart`;console.log("🔄 Redirigiendo al carrito..."),console.log("🔄 URL del carrito:",d),window.location.href=d;return}}catch(f){console.error("❌ Error durante intento de recuperación:",f)}alert(`Error durante el proceso: ${o.message}. Si el álbum se agregó al carrito, puede ir manualmente a la página del carrito.`)}finally{Z(!1)}}},disabled:L,children:L?i.jsxs(i.Fragment,{children:[i.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[i.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),i.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):"Comprar ahora"}),i.jsx("button",{className:"flex-1 py-3 px-4 rounded-lg bg-gray-200 text-gray-700 font-semibold shadow hover:bg-gray-300 transition",onClick:c,disabled:L,children:"Continuar editando"})]}),"        "]})},ge=({page:P,pageIdx:c})=>{let n="",j="";switch(P.type){case"cover":n="Portada",j="📚";break;case"final":n="Contraportada",j="📖";break;case"content":n=`Página ${P.pageNumber||c+1}`,j="📄";break;default:n=`Página ${c+1}`,j="📄"}return i.jsxs("div",{className:"flex flex-col items-center justify-center w-full h-full bg-gray-50 border-2 border-gray-200 rounded-lg",style:{minHeight:"400px"},children:[i.jsx("div",{className:"text-6xl mb-4",children:j}),i.jsx("div",{className:"text-lg font-semibold text-gray-700 mb-2",children:n}),i.jsx("div",{className:"text-sm text-gray-500",children:"Vista previa"}),P.layout&&i.jsxs("div",{className:"text-xs text-gray-400 mt-2",children:["Layout: ",P.layout.name||"Personalizado"]})]})};async function Ne({pages:P,workspaceDimensions:c,presetData:n}){var $,Q,H,Y,K,L,Z,q,W,D,J,B;const j={};function O(x,E,p,k,S,C){if(!E||!x){console.warn("⚠️ No se puede dibujar: contexto o imagen no válidos");return}const _=E.width,w=E.height;if(_===0||w===0){console.warn("⚠️ Imagen con dimensiones cero:",{sWidth:_,sHeight:w});return}if(S<=0||C<=0){console.warn("⚠️ Dimensiones de destino inválidas:",{dWidth:S,dHeight:C});return}const R=S/C,A=_/w;let s,u,N,v;R>A?(N=_,v=N/R,s=0,u=(w-v)/2):(v=w,N=v*R,s=(_-N)/2,u=0);try{x.save(),x.imageSmoothingQuality="high",x.drawImage(E,Math.max(0,s),Math.max(0,u),Math.min(N,_-s),Math.min(v,w-u),p,k,S,C),x.restore()}catch(e){console.error("❌ Error al dibujar imagen:",e),console.error("Detalles:",{source:{x:s,y:u,width:N,height:v},dest:{x:p,y:k,width:S,height:C},imgSize:{width:_,height:w}})}}for(const x of P)try{const E=document.createElement("canvas"),p=E.getContext("2d",{willReadFrequently:!0});E.width=c.width,E.height=c.height,p.scale(1,1),p.imageSmoothingEnabled=!0,p.imageSmoothingQuality="high",p.textRendering="geometricPrecision",p.webkitImageSmoothingEnabled=!0,p.mozImageSmoothingEnabled=!0,p.msImageSmoothingEnabled=!0;let k=null;if(x.type==="cover"&&(n!=null&&n.cover_image)?k=n.cover_image.startsWith("http")?n.cover_image:`/storage/images/item_preset/${n.cover_image}`:x.type==="content"&&(n!=null&&n.content_layer_image)?k=n.content_layer_image.startsWith("http")?n.content_layer_image:`/storage/images/item_preset/${n.content_layer_image}`:x.type==="final"&&(n!=null&&n.final_layer_image)&&(k=n.final_layer_image.startsWith("http")?n.final_layer_image:`/storage/images/item_preset/${n.final_layer_image}`),k||(p.fillStyle="#ffffff",p.fillRect(0,0,c.width,c.height)),k){const A=new window.Image;A.crossOrigin="anonymous",A.src=k,await new Promise((s,u)=>{if(A.complete)return s();A.onload=s,A.onerror=u}),O(p,A,0,0,c.width,c.height)}else p.fillStyle="#ffffff",p.fillRect(0,0,c.width,c.height);if(x.cells&&Array.isArray(x.cells)){const A=[...x.cells].sort((s,u)=>{var e,r,t,o;const N=((e=s.position)==null?void 0:e.y)||0,v=((r=u.position)==null?void 0:r.y)||0;return N!==v?N-v:(((t=s.position)==null?void 0:t.x)||0)-(((o=u.position)==null?void 0:o.x)||0)});for(const s of A){if(!s||!s.elements)continue;const u=(($=s.size)==null?void 0:$.width)||c.width,N=((Q=s.size)==null?void 0:Q.height)||c.height,v=((H=s.position)==null?void 0:H.x)||0,e=((Y=s.position)==null?void 0:Y.y)||0;s.size||console.warn("⚠️ cell.size no definido, usando tamaño workspace",s);const r=[...s.elements||[]].sort((t,o)=>(t.zIndex||0)-(o.zIndex||0));for(const t of r)if(!(t.type==="image"&&(t.id==="cover-base"||t.id==="final-base"||typeof t.id=="string"&&t.id.startsWith("content-base-")))&&!(!t||t.type!=="image"&&t.type!=="text"||!t.content)&&t.type==="image")try{const o=new Image;o.crossOrigin="anonymous",await new Promise((F,z)=>{o.onload=F,o.onerror=z,o.src=t.content});const f=((K=t.position)==null?void 0:K.x)!==void 0&&Math.abs(t.position.x)<=1,d=((L=t.position)==null?void 0:L.y)!==void 0&&Math.abs(t.position.y)<=1,a=((Z=t.size)==null?void 0:Z.width)!==void 0&&t.size.width<=1,g=((q=t.size)==null?void 0:q.height)!==void 0&&t.size.height<=1,m=f?t.position.x*u:((W=t.position)==null?void 0:W.x)||0,y=d?t.position.y*N:((D=t.position)==null?void 0:D.y)||0,b=a?t.size.width*u:((J=t.size)==null?void 0:J.width)||u,I=g?t.size.height*N:((B=t.size)==null?void 0:B.height)||N,h=v+m,l=e+y;console.log("📐 Renderizando elemento:",{elementId:t.id,cellId:s.id,cellPosition:{x:v,y:e,width:u,height:N},elementPosition:{x:m,y,width:b,height:I},finalPosition:{dx:h,dy:l},isRelative:{x:f,y:d,w:a,h:g},elementData:t}),O(p,o,h,l,b,I)}catch(o){console.error("Error al cargar imagen:",o,t)}}}const S=document.createElement("canvas"),C=S.getContext("2d"),_=900;let w,R;c.width>c.height?(w=Math.min(_,c.width),R=w/c.width*c.height):(R=Math.min(_,c.height),w=R/c.height*c.width),w=Math.round(w),R=Math.round(R),S.width=w,S.height=R,C.imageSmoothingEnabled=!0,C.imageSmoothingQuality="high",C.webkitImageSmoothingEnabled=!0,C.mozImageSmoothingEnabled=!0,C.msImageSmoothingEnabled=!0,C.drawImage(E,0,0,E.width,E.height,0,0,w,R),j[x.id]=S.toDataURL("image/png",.92)}catch(E){console.error(`❌ Error generando thumbnail para página ${x.id}:`,E),j[x.id]=null}return j}export{Ce as B,Ne as g};
